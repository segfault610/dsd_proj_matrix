`timescale 1ns / 1ps
module tb_fir_filter;
    parameter TAPS = 8;
    parameter DATA_WIDTH = 16;
    parameter CLK_PERIOD = 10;

    reg clk, rst;
    reg sample_valid;
    reg signed [DATA_WIDTH-1:0] sample_in;
    reg signed [DATA_WIDTH-1:0] coeffs [0:TAPS-1];
    wire signed [2*DATA_WIDTH-1:0] filtered_out;
    wire output_valid;
    integer i, count;

    fir_filter #(TAPS, DATA_WIDTH) dut (
        .clk(clk), .rst(rst),
        .sample_in(sample_in),
        .sample_valid(sample_valid),
        .coeffs(coeffs),
        .filtered_out(filtered_out),
        .output_valid(output_valid)
    );

    initial begin
        clk = 0;
        forever #(CLK_PERIOD/2) clk = ~clk;
    end

    initial begin
        $dumpfile("tb_fir_filter.vcd");
        $dumpvars(0, tb_fir_filter);

        rst = 1; sample_valid = 0; sample_in = 0;
        for (i = 0; i < TAPS; i = i + 1) coeffs[i] = 0;
        # (CLK_PERIOD * 2);
        rst = 0;
        #CLK_PERIOD;

        // example coefficients
        coeffs[0] = 16'sd1; coeffs[1] = 16'sd2; coeffs[2] = 16'sd3; coeffs[3] = 16'sd4;
        coeffs[4] = 16'sd3; coeffs[5] = 16'sd2; coeffs[6] = 16'sd1; coeffs[7] = 16'sd0;

        // Impulse test
        sample_in = 16'sh7FFF; sample_valid = 1; @(posedge clk);
        sample_in = 0; sample_valid = 1;
        count = 0;
        for (i = 0; i < TAPS + 2; i = i + 1) begin
            @(posedge clk);
            if (output_valid) begin
                $display("Impulse Response[%0d] = %0d", count, filtered_out);
                count = count + 1;
            end
        end
        sample_valid = 0;

        # (CLK_PERIOD * 10);
        $finish;
    end

endmodule

